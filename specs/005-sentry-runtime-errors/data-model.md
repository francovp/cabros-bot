# Data Model: Runtime Error Monitoring with Sentry

**Feature**: `005-sentry-runtime-errors` | **Date**: 2025-11-26  
**Purpose**: Define entities, relationships, and validation rules for capturing runtime errors and external failures via Sentry.

---

## Core Entities

### 1. ErrorEvent

Represents a normalized error/event that the monitoring service prepares and forwards to Sentry.

```typescript
// Conceptual shape used inside SentryService before calling Sentry.captureException
interface ErrorEvent {
  id?: string;                          // Optional Sentry event ID returned after capture
  type: 'runtime_error' | 'process_error' | 'external_failure';
  channel: RuntimeChannelId;            // High-level origin (HTTP, Telegram, WhatsApp, etc.)
  feature?: string;                     // Feature flag / domain (e.g., 'alerts', 'gemini-grounding', 'news-monitor')
  message: string;                      // High-level error message shown in Sentry
  errorName?: string;                   // Underlying error name (Error, TypeError, etc.)
  stack?: string;                       // Sanitized stack trace when available
  environment: string;                  // Derived Sentry environment (production/preview/development/...)
  release?: string;                     // Derived release identifier (e.g., commit hash)
  isProcessLevel: boolean;              // True if from uncaughtException/unhandledRejection
  timestamp: number;                    // Unix timestamp in ms when event was built
  http?: HttpErrorContext;              // HTTP-specific context (webhooks, news monitor)
  external?: ExternalFailureContext;    // External provider failure metadata
  alert?: AlertContext;                 // Context for alert webhook content
  news?: NewsContext;                   // Context for news monitor requests
  extra?: Record<string, unknown>;      // Additional structured metadata when needed
}

// Allowed channels for tagging and filtering in Sentry
export type RuntimeChannelId =
  | 'http-alert'        // /api/webhook/alert handler
  | 'news-monitor'      // /api/news-monitor handler
  | 'telegram'          // Telegram notifications
  | 'whatsapp'          // WhatsApp notifications (GreenAPI)
  | 'grounding'         // Gemini grounding/enrichment flow
  | 'news-enrichment'   // Optional secondary LLM enrichment
  | 'process';          // Process-level errors not tied to a specific handler
```

#### Validation Rules

- `type`: MUST be one of `'runtime_error'`, `'process_error'`, `'external_failure'`.
- `channel`: MUST be a valid `RuntimeChannelId` value.
- `message`: Required, non-empty string, max ~500 characters after normalization.
- `errorName`: Optional, non-empty string when present, max 100 characters.
- `stack`: Optional; when present, SHOULD be truncated to a reasonable size (e.g., 4–8 KB) before sending.
- `environment`: Required, non-empty string (e.g., `production`, `preview`, `development`).
- `release`: Optional; when present, non-empty string, max 200 characters.
- `timestamp`: Required, positive integer (Unix epoch milliseconds).
- `isProcessLevel`: Boolean; MUST be `true` only for events sourced from process-level handlers.
- `http`, `external`, `alert`, `news`: Optional, but when present MUST conform to their respective schemas.

**Relationships**:

- `ErrorEvent` is constructed by `SentryService` from:
  - Caught errors in HTTP handlers (`alert.js`, `newsMonitor.js`).
  - Final results of `NotificationManager.sendToAll()` / `sendWithRetry()` when external retries are exhausted.
  - Process-level events (`uncaughtException`, `unhandledRejection`) surfaced by the Node SDK integrations.
- `ErrorEvent` is not persisted locally; it is serialized into Sentry's own event format.

---

### 2. HttpErrorContext

Context for HTTP-level failures in Express handlers.

```typescript
interface HttpErrorContext {
  endpoint: string;                     // e.g., '/api/webhook/alert', '/api/news-monitor'
  method: 'GET' | 'POST' | 'PUT' | 'DELETE' | 'PATCH';
  statusCode: number;                   // HTTP status returned to client (e.g., 400, 500)
  requestId?: string;                   // Correlation ID when available (news monitor already generates one)
  featureFlagState?: Record<string, boolean>; // Snapshot of relevant feature flags (ENABLE_NEWS_MONITOR, etc.)
}
```

**Validation Rules**:

- `endpoint`: Required, non-empty string starting with `/`, max 200 characters.
- `method`: Required; one of the listed HTTP verbs.
- `statusCode`: Required; integer in range [100, 599].
- `requestId`: Optional; non-empty string when present.
- `featureFlagState`: Optional; keys are env-var-like strings, values are booleans.

**Relationships**:

- Attached to `ErrorEvent.http` when an error occurs in `/api/webhook/alert` or `/api/news-monitor`.
- `requestId` SHOULD mirror the existing ID generated by `NewsMonitorHandler` when present.

---

### 3. ExternalFailureContext

Metadata for failures in integrations that already implement retry and fallback.

```typescript
interface ExternalFailureContext {
  provider: ExternalProviderId;         // External integration name
  attemptCount: number;                 // Total attempts performed (e.g., from retryHelper)
  durationMs: number;                   // Total elapsed time for all attempts
  lastErrorMessage?: string;            // Final error message after retries
  lastErrorCode?: string | number;      // Optional provider-specific error code/status
}

export type ExternalProviderId =
  | 'telegram-api'
  | 'whatsapp-greenapi'
  | 'gemini'
  | 'azure-llm'
  | 'binance'
  | 'url-shortener-bitly'
  | 'url-shortener-tinyurl'
  | 'url-shortener-other';
```

**Validation Rules**:

- `provider`: Required; MUST be one of the allowed identifiers above.
- `attemptCount`: Required; integer ≥ 1, typically ≤ 3 for retry-based integrations.
- `durationMs`: Required; non-negative integer.
- `lastErrorMessage`: Optional; non-empty string when present, truncated to max ~1,000 characters.
- `lastErrorCode`: Optional; may be HTTP status code, provider error code, or other numeric identifier.

**Relationships**:

- Attached to `ErrorEvent.external` when `type === 'external_failure'` and all retries have been exhausted for a given provider.
- Built using data from `retryHelper.sendWithRetry()` and channel-specific logic (e.g., `WhatsAppService`, `TelegramService`).

---

### 4. AlertContext

Captures non-sensitive information about alert webhook payloads.

```typescript
interface AlertContext {
  textLength: number;                   // Length of alert text in characters
  hasEnrichment: boolean;               // Whether `alert.enriched` was present
  enrichedSource?: 'gemini-grounding' | 'news-monitor' | 'other';
  truncated: boolean;                   // Whether text was truncated before sending to channels
}
```

**Validation Rules**:

- `textLength`: Required; integer ≥ 0.
- `hasEnrichment`: Required; boolean.
- `enrichedSource`: Optional; if present, one of the allowed string literals.
- `truncated`: Required; boolean.

**Relationships**:

- Attached to `ErrorEvent.alert` when an error arises while processing `/api/webhook/alert`.
- Derived from the `alert` object passed into `NotificationManager.sendToAll()`.

---

### 5. NewsContext

Summarized context for `/api/news-monitor` requests.

```typescript
interface NewsContext {
  symbolCount: number;                  // Total number of symbols requested
  alertsSent: number;                   // Number of alerts actually sent
  summaryStatus: {
    analyzed: number;
    cached: number;
    timeout: number;
    error: number;
  };
}
```

**Validation Rules**:

- `symbolCount`: Required; integer ≥ 0.
- `alertsSent`: Required; integer ≥ 0.
- `summaryStatus`: Required; each field integer ≥ 0.

**Relationships**:

- Attached to `ErrorEvent.news` when an unexpected error occurs in `NewsMonitorHandler.handleRequest()`.
- Mirrors the summary object already returned in the HTTP response for `/api/news-monitor`.

---

### 6. MonitoringConfiguration

Represents resolved monitoring configuration derived from environment variables.

```typescript
interface MonitoringConfiguration {
  enabled: boolean;                     // True when monitoring is active
  dsn?: string;                         // DSN used for Sentry.init (optional if SDK reads from env)
  environment: string;                  // Effective Sentry environment string
  release?: string;                     // Effective release identifier
  sendAlertContent: boolean;            // Whether full alert/news text is allowed in events (FR-007)
  sampleRateErrors: number;             // Error sample rate (0.0-1.0), typically 1.0 for this feature
}
```

**Validation Rules**:

- `enabled`: Required; boolean.
- `dsn`: Optional; non-empty string when present.
- `environment`: Required; non-empty string.
- `release`: Optional; non-empty string when present.
- `sendAlertContent`: Required; boolean; defaults to `true` per FR-007.
- `sampleRateErrors`: Required; number in [0.0, 1.0]; for this feature, default SHOULD be 1.0.

**Relationships**:

- Computed once at startup by `SentryService.init()` using env vars (`ENABLE_SENTRY`, `SENTRY_DSN`, `SENTRY_ENVIRONMENT`, `SENTRY_RELEASE`, `RENDER`, `IS_PULL_REQUEST`, `NODE_ENV`, `RENDER_GIT_COMMIT`).
- Read-only during a process lifetime; changes require restart.

---

### 7. MonitoringServiceState (Internal)

Internal state for the monitoring service, used for tests and health checks.

```typescript
interface MonitoringServiceState {
  configured: boolean;                  // Sentry.init was called successfully
  enabled: boolean;                     // Monitoring is logically enabled (config + DSN valid)
  lastInitError?: string;               // Last initialization error (if any)
}
```

**Validation Rules**:

- `configured`: Required; boolean.
- `enabled`: Required; boolean.
- `lastInitError`: Optional; non-empty string when present.

**Relationships**:

- Hosted by `SentryService` and exposed indirectly to tests (e.g., via `isEnabled()` or debug getters).
- Not exposed over public HTTP APIs.

---

## State Transitions

### Error Capture Flow

```text
1. Error occurs in runtime
   ├─ HTTP handler (alert, news-monitor)
   ├─ Notification channel (Telegram, WhatsApp)
   └─ Process-level (uncaughtException/unhandledRejection)

2. Determine if monitoring is enabled
   ├─ If MonitoringConfiguration.enabled === false → skip capture (no-op)
   └─ Else → proceed

3. Build ErrorEvent
   ├─ Map origin to RuntimeChannelId
   ├─ Populate type (runtime_error / process_error / external_failure)
   ├─ Derive tags/context fields (http, external, alert, news)
   └─ Attach environment and release from MonitoringConfiguration

4. Send to Sentry
   ├─ SentryService wraps `Sentry.captureException(...)` or similar
   └─ Optionally store returned event ID on ErrorEvent.id for logging

5. Preserve original behavior
   ├─ HTTP handlers return same status/body as before
   ├─ Notification flows still resolve Promise with same SendResult
   └─ Process-level behavior (e.g., crash vs warn) governed by SDK integrations
```

### Configuration Resolution Flow

```text
1. Read raw env vars
   ├─ ENABLE_SENTRY
   ├─ SENTRY_DSN
   ├─ SENTRY_ENVIRONMENT (optional)
   ├─ SENTRY_RELEASE (optional)
   ├─ RENDER, IS_PULL_REQUEST, NODE_ENV, RENDER_GIT_COMMIT

2. Derive environment
   ├─ If SENTRY_ENVIRONMENT set → use it
   ├─ Else if RENDER === 'true' && IS_PULL_REQUEST === 'true' → 'preview'
   ├─ Else if NODE_ENV === 'production' OR RENDER === 'true' → 'production'
   └─ Else → 'development'

3. Derive release
   ├─ If SENTRY_RELEASE set → use it
   ├─ Else if RENDER_GIT_COMMIT set → use short commit hash
   └─ Else → undefined (let SDK auto-detect if supported)

4. Compute enabled
   ├─ enabled = (ENABLE_SENTRY === 'true' && SENTRY_DSN is non-empty)

5. Expose MonitoringConfiguration
   └─ Used by SentryService and tests
```

---

## Validation Summary

| Entity                    | Critical Validations                                                     |
|---------------------------|--------------------------------------------------------------------------|
| ErrorEvent                | type, channel, message, environment, timestamp, nested contexts valid   |
| HttpErrorContext          | endpoint, method, statusCode                                             |
| ExternalFailureContext    | provider, attemptCount, durationMs, trimmed error messages               |
| AlertContext              | textLength ≥ 0, hasEnrichment, truncated                                 |
| NewsContext               | symbolCount, alertsSent, summaryStatus counts ≥ 0                        |
| MonitoringConfiguration   | enabled boolean, environment non-empty, sampleRateErrors in [0.0, 1.0]   |
| MonitoringServiceState    | configured/enabled booleans, optional lastInitError string               |

These data structures form the internal contract for the `SentryService` implementation and its tests. They do **not** alter public HTTP APIs but define what information is attached to Sentry events for operational visibility.
