# Implementation Plan: Multi-Channel Alerts (WhatsApp & Telegram)

**Branch**: `002-whatsapp-alerts` | **Date**: 2025-10-29 | **Spec**: [002-whatsapp-alerts/spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-whatsapp-alerts/spec.md`

**Note**: This plan is auto-generated by `/speckit.plan` workflow. See `.specify/templates/commands/plan.md` for execution details.

## Summary

Add WhatsApp alert channel integration alongside existing Telegram alerts. The system will use GreenAPI's sendMessage endpoint with native Node.js fetch API (no external HTTP client dependency). When alerts arrive at the webhook, they are enriched once (Gemini grounding) and sent to both configured channels with appropriate formatting (MarkdownV2 for Telegram, WhatsApp markdown for WhatsApp). Failures retry with exponential backoff (1s → 2s → 4s, max 3); exhausted retries return 200 OK to webhook caller and notify admin via Telegram.

## Technical Context

**Language/Version**: Node.js 20.x (from package.json engines)  
**Primary Dependencies**: Express 4.17+, telegraf 4.3+ (existing); NO new HTTP client (use native fetch)  
**Storage**: N/A (stateless webhook handler; uses env vars for config)  
**Testing**: jest 30.2+ (existing); minimal tests for WhatsApp send + retry logic + formatting  
**Target Platform**: Node.js server (Linux/macOS, same as current)  
**Project Type**: Single web application (Express webhook + background CLI commands)  
**Performance Goals**: 99% successful delivery rate; 10-second delivery SLA per spec (includes all retries)  
**Constraints**: GreenAPI 50 RPS limit (respected via per-message backoff); 20K char message limit; Telegram-only on config errors (backward compatible)  
**Scale/Scope**: Multi-channel notification service; ~5-10 new files (services, handlers, tests); zero breaking changes to existing API

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Justification |
|-----------|--------|---------------|
| Code Quality & Readability | ✅ PASS | New code uses clear naming (WhatsAppService, NotificationChannel), focused modules, small functions. Formatting conversion and retry logic will be documented with "why" comments. |
| Simplicity & Minimalism | ✅ PASS | Native fetch API chosen (no external HTTP client). Single-pass enrichment (one grounding request, reused). Per-message retry (no global queueing). Minimal new abstractions (NotificationChannel, WhatsAppService). |
| Testing Policy (No TDD) | ✅ PASS | Critical logic (retry backoff, formatting conversion, error handling) will have focused unit tests. No TDD mandate enforced. Existing jest setup reused. |
| Review & Quality Gates | ✅ PASS | Plan includes contracts and quickstart. CI already runs eslint + jest. Plan refactors Telegram service without breaking changes. |
| Incremental Delivery | ✅ PASS | Changes are backward compatible. WhatsApp disabled by default (`ENABLE_WHATSAPP_ALERTS=false`). Feature can be delivered in two phases: (P1) single-channel, (P2) dual-channel grounding. |

**Gate Result**: ✅ PASS - No violations. Proceed to Phase 0.

## Project Structure

### Documentation (this feature)

```text
specs/002-whatsapp-alerts/
├── spec.md              # Feature specification (completed)
├── plan.md              # This file (in progress)
├── research.md          # Phase 0 output (pending)
├── data-model.md        # Phase 1 output (pending)
├── quickstart.md        # Phase 1 output (pending)
├── contracts/           # Phase 1 output (pending)
│   └── alert-webhook.openapi.yml
├── checklists/
│   └── requirements.md  # (existing)
└── tasks.md             # Phase 2 output (pending)
```

### Source Code (repository root)

```text
src/
├── services/
│   ├── notification/
│   │   ├── NotificationChannel.js      # (new abstract base)
│   │   ├── WhatsAppService.js          # (new concrete impl)
│   │   ├── TelegramService.js          # (refactored from existing alert.js)
│   │   ├── NotificationManager.js      # (new coordinator)
│   │   └── formatters/
│   │       ├── markdownV2Formatter.js  # (existing, move from alert.js)
│   │       └── whatsappMarkdownFormatter.js  # (new)
│   ├── grounding/
│   │   ├── grounding.js                # (existing, reuse for both channels)
│   │   └── ...other existing files
│   ├── webhooks/
│   │   └── handlers/
│   │       └── alert/
│   │           ├── alert.js            # (refactor to use NotificationManager)
│   │           └── grounding.js        # (existing, unchanged)
│   └── lib/
│       └── retryHelper.js              # (new utility for backoff)
│
└── controllers/
    └── commands.js                      # (existing, no changes for P1)

tests/
├── unit/
│   ├── whatsapp-service.test.js        # (new)
│   ├── whatsapp-formatter.test.js      # (new)
│   ├── retry-helper.test.js            # (new)
│   └── ...existing tests
├── integration/
│   ├── alert-whatsapp.test.js          # (new)
│   └── ...existing tests
```

**Structure Decision**: Single project (Option 1). All WhatsApp integration lives under `src/services/notification/` (new directory). Existing Telegram logic refactored into TelegramService. Shared grounding service reused. Minimal file additions; no new frontend, API, or mobile code.

## Complexity Tracking

> No constitution violations detected. No exemptions needed.

| Aspect | Decision | Rationale |
|--------|----------|-----------|
| HTTP Client | Native fetch (no dependency) | Node 18+ has built-in fetch; reduces bundle size; keeps dependencies minimal |
| Notification Abstraction | NotificationChannel base class + concrete impls | Enables future channels (Discord, Slack) without refactoring alert handler |
| Retry Strategy | Per-message exponential backoff (no queue) | Simplifies initial implementation; respects GreenAPI 50 RPS limit |
| Grounding | Single request in webhook handler, reused for both channels | Reduces API calls; enrichment in webhook handler before passing to NotificationManager |
| Formatting | Two formatters (MarkdownV2, WhatsAppMarkdown) | Clear separation; each handles its channel's constraints |

## Next Steps

- **Phase 0**: Research fetch API patterns, MarkdownV2 conversion, and error handling. Output: `research.md`
- **Phase 1**: Create data models, API contracts, and quickstart. Output: `data-model.md`, `contracts/`, `quickstart.md`
- **Phase 2** (via `/speckit.tasks`): Generate implementation tasks based on design



