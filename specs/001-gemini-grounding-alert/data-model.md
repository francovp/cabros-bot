# Data Model Documentation

## Core Entities

### Alert
Represents an incoming webhook alert that needs to be processed and enriched.

```typescript
interface Alert {
  text: string;              // The original alert text
  receivedAt: Date;          // Timestamp when alert was received
  metadata?: object;         // Optional additional context
}
```

### SearchResult
Represents a single search result used for grounding context.

```typescript
interface SearchResult {
  title: string;            // Title of the search result
  snippet: string;          // Short excerpt/description
  url: string;             // Full URL to the source
  sourceDomain: string;    // Extracted domain for filtering
}
```

### GroundedContext
Collection of search results used as evidence for the Gemini prompt.

```typescript
interface GroundedContext {
  query: string;           // Derived search query
  results: SearchResult[]; // Array of search results (limited by GROUNDING_MAX_SOURCES)
  timestamp: Date;         // When context was collected
}
```

### GeminiResponse
The enriched content generated by Gemini using grounding.

```typescript
interface GeminiResponse {
  summary: string;         // Generated summary
  confidence?: number;     // Optional confidence score
  citations: SearchResult[]; // Sources used in generation
  error?: string;         // Optional error message if enrichment failed
}
```

### TelegramMessage
Final formatted message to be sent to Telegram.

```typescript
interface TelegramMessage {
  text: string;           // Full message text (original + enriched)
  parseMode?: string;     // Optional parse mode (MarkdownV2)
  disableWebPagePreview?: boolean; // Control link previews
}
```

## State Transitions

1. Webhook Received
   - Input: Raw webhook body
   - Output: Validated Alert object

2. Search Query Generation
   - Input: Alert text
   - Output: Optimized search query

3. Context Collection
   - Input: Search query
   - Output: GroundedContext with search results

4. Content Generation
   - Input: Alert + GroundedContext
   - Output: GeminiResponse with summary and citations

5. Message Formatting
   - Input: Original Alert + GeminiResponse
   - Output: Formatted TelegramMessage

## Validation Rules

### Alert Validation
- text: Required, non-empty string
- text length: Must be truncated if > 4000 chars
- metadata: Optional, must be valid JSON if present

### SearchResult Validation
- url: Must be valid HTTP/HTTPS URL
- sourceDomain: Must be extracted from URL
- title/snippet: Required, non-empty strings

### GeminiResponse Validation
- summary: Required, non-empty string
- citations: Must reference valid SearchResults
- confidence: Optional number between 0-1

### Message Formatting
- Must escape special Markdown characters
- Must properly format URLs
- Must maintain message size limits

## Concrete Limits and Formatting Rules

These limits are normative for implementation and tests:

- Summary length: recommended target <= 250 characters OR <= 3 sentences. Implementations SHOULD enforce one of these and tests SHOULD assert compliance.
- Maximum number of sources presented: `GROUNDING_MAX_SOURCES` with default = 3. The orchestrator and clients MUST respect this limit when forming `GroundedContext.results` and when formatting the final message.
- Citation fields:
  - `title`: string, max 80 characters; if longer, truncate with an ellipsis for display.
  - `snippet`: string, max 160 characters; optional but preferred when available; if longer, truncate to 160 chars.
  - `url`: valid HTTP/HTTPS URL; display as-is but ensure Markdown escaping and optionally disable web previews.
- `confidence`: Optional numeric field in `GeminiResponse`. If present it MUST be a number between 0.0 and 1.0. Implementations may omit it if the provider doesn't return a score.
- Telegram message assembly:
- Telegram message assembly:

- The final `TelegramMessage.text` MUST contain the original alert text first, then a clear separator (e.g., "--- Enriched Context ---"), then the summary, then a bulleted list of sources. Example formatting:

```text
<original alert text>

--- Enriched Context ---
Summary: <summary text up to 250 chars>
Sources:
- <title> — <snippet (optional)> — <url>
- <title> — <url>
```

- Messages MUST escape MarkdownV2 special characters and observe Telegram size limits. When the total message exceeds Telegram limits, the implementation SHOULD truncate citations (oldest/lowest-priority) to fit and log the truncation event.

These rules are the canonical contract for unit and integration tests. See `spec.md` reference and ensure all tasks that implement or test generation/formatting reference these constraints.
